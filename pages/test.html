<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP查询结果展示</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Misans', Arial, sans-serif;
        }

        .card {
            border-radius: 15px;
        }

        .container {
            margin-top: 50px;
        }

        .card-header {
            background-color: #f7f7f9;
            font-size: 1.25rem;
        }
    </style>
    <link rel="stylesheet" href="https://font.sec.miui.com/font/css?family=MiSans:400,550:MiSans">
</head>

<body>
    <div class="container">
        <!-- 1号块：原有API信息 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">自有 API 查询结果</div>
            <div class="card-body">
                <p class="card-text" id="result">正在加载...</p>
            </div>
        </div>

        <!-- 2号块：Cloudflare API 信息 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">Cloudflare API 查询结果</div>
            <div class="card-body">
                <p class="card-text" id="connection-info">正在获取连接信息...</p>
            </div>
        </div>

        <!-- 3号块：Bilibili API 信息 -->
        <div class="card shadow-sm">
            <div class="card-header">Bilibili API 查询结果</div>
            <div class="card-body">
                <p class="card-text" id="bilibili-info">正在获取数据...</p>
            </div>
        </div>
    </div>

    <script>
        const MAX_HTTPS_FAILURES = 3;
        let httpsFailureCount = 0;
        let isHttpsAvailable = false;

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function fetchIPData() {
            const ip = getQueryParam('ip');
            //const host = window.location.host;
            //const apiUrlHttps = ip ? `https://${host}/ip-lookup?ip=${ip}` : `https://${host}/ip-lookup`;
            //const apiUrlHttp = ip ? `http://${host}/ip-lookup?ip=${ip}` : `http://${host}/ip-lookup`;
            const protocolAndHost = window.location.protocol + '//' + window.location.host;
            const apiUrl = ip ? `${protocolAndHost}/ip-lookup?ip=${ip}` : `${protocolAndHost}/ip-lookup`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                updateResult(data);
                console.log("Request succeeded.");
            } catch (error) {
                console.error('Request failed.');
                document.getElementById('result').innerHTML = '查询失败，请检查网络连接。';
            }

            // 尝试使用HTTPS请求
            /*try {
                const response = await fetch(apiUrlHttps);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                isHttpsAvailable = true;
                const data = await response.json();
                updateResult(data);
                console.log("HTTPS is available. No further checks needed.");
            } catch (error) {
                httpsFailureCount++;
                console.error('HTTPS request failed, count: ', httpsFailureCount);
                if (httpsFailureCount < MAX_HTTPS_FAILURES) {
                    try {
                        const response = await fetch(apiUrlHttp);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        const data = await response.json();
                        updateResult(data);
                        console.log("HTTP fallback succeeded.");
                    } catch (error) {
                        console.error('HTTP request failed as well.');
                        document.getElementById('result').innerHTML = '查询失败，请检查网络连接。';
                    }
                } else {
                    console.log("HTTPS failed too many times. Stop further attempts.");
                    document.getElementById('result').innerHTML = '查询失败，请检查网络连接。';
                }
            } */
        }

        function updateResult(data) {
            const countryCode = data.country_code ? data.country_code.toLowerCase() : '';
            const flagIcon = countryCode ? `<span class="flag-icon flag-icon-${countryCode}"></span>` : '';

            const result = `
                <strong>IP地址:</strong> ${data.ip || '未知'}<br>
                <strong>ASN:</strong> ${data.asn || '未知'}<br>
                <strong>域名:</strong> ${data.domain || '未知'}<br>
                <strong>ISP:</strong> ${data.isp || '未知'}<br>
                <strong>大洲代码:</strong> ${data.continent_code || '未知'}<br>
                <strong>大洲全称:</strong> ${data.continent_name || '未知'}<br>
                <strong>国家/地区代码:</strong> ${data.country_code || '未知'} ${flagIcon}<br>
                <strong>国家/地区全称:</strong> ${data.country_name || '未知'}<br>
                <strong>User-Agent:</strong> ${data.user_agent || '未知'}
            `;
            document.getElementById('result').innerHTML = result;
        }

        async function fetchCloudflareTraceData() {
            try {
                const response = await fetch('https://www.cloudflare.com/cdn-cgi/trace');
                const text = await response.text();
                const data = text.split('\n').reduce((obj, line) => {
                    const parts = line.split('=');
                    if (parts.length === 2) {
                        obj[parts[0]] = parts[1];
                    }
                    return obj;
                }, {});

                const infoHtml = `
                    <strong>IP地址:</strong> ${data.ip}<br>
                    <strong>国家/地区:</strong> ${data.loc}<br>                    
                    <strong>Cloudflare数据中心:</strong> ${data.colo}<br>
                    <strong>HTTP版本:</strong> ${data.http}<br>
                    <strong>TLS版本:</strong> ${data.tls}<br>
                    <strong>User-Agent:</strong> ${data.uag}<br>
                    <strong>线路:</strong> ${data.fl}<br>
                `;

                document.getElementById('connection-info').innerHTML = infoHtml;
            } catch (error) {
                console.error('Request to Cloudflare trace failed: ', error);
                document.getElementById('connection-info').innerHTML = '无法获取 Cloudflare 连接信息';
            }
        }

        async function fetchBilibiliIPData() {
            try {
                const responseIP = await fetch('https://myip.ipip.net/json');
                if (!responseIP.ok) {
                    throw new Error('IP API response was not ok');
                }
                const dataIP = await responseIP.json();
                const ip = dataIP.data.ip;
                const protocolAndHost = window.location.protocol + '//' + window.location.host;
                const apiUrl = `${protocolAndHost}/bilibili?ip=${ip}`;
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                if (data.code === 0 && data.data) {
                    const result = `
                <strong>IP地址:</strong> ${data.data.addr || '未知'}<br>
                <strong>国家:</strong> ${data.data.country || '未知'}<br>
                <strong>省份:</strong> ${data.data.province || '未知'}<br>
                <strong>城市:</strong> ${data.data.city || '未知'}<br>
                <strong>ISP:</strong> ${data.data.isp || '未知'}<br>
                <strong>纬度:</strong> ${data.data.latitude || '未知'}<br>
                <strong>经度:</strong> ${data.data.longitude || '未知'}
            `;
                    document.getElementById('bilibili-info').innerHTML = result;
                } else {
                    throw new Error('Data retrieval was unsuccessful');
                }
            } catch (error) {
                console.error('Request to Bilibili IP API failed: ', error);
                document.getElementById('bilibili-info').innerHTML = '无法获取数据，请检查网络连接。';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const userIp = getQueryParam('ip');
            fetchIPData();
            fetchCloudflareTraceData();
            fetchBilibiliIPData(userIp);
        });
    </script>
</body>

</html>
